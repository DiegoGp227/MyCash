// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// AUTH & USER
// ========================================

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  username  String?    @unique

  role      UserRole   @default(USER)
  status    UserStatus @default(ACTIVE)

  cutoffDay Int        @default(1) // Validar: 1-31 en app
  currency  String     @default("COP")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts      Account[]
  categories    Category[]
  subcategories Subcategory[]
  transactions  Transaction[]
  transfers     Transfer[]
  budgets       Budget[]
  goals         Goal[]
  debts         Debt[]

  @@index([email])
}

enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ========================================
// CUENTAS
// ========================================

model Account {
  id       String      @id @default(cuid())
  userId   String
  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name     String
  type     AccountType
  balance  Decimal     @default(0) @db.Decimal(15, 2)
  color    String?
  icon     String?
  isActive Boolean     @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  transactions  Transaction[]
  transfersFrom Transfer[] @relation("TransfersFrom")
  transfersTo   Transfer[] @relation("TransfersTo")
  
  @@index([userId])
  @@index([isActive])
}

enum AccountType {
  CASH
  BANK
  CREDIT_CARD
  SAVINGS
  INVESTMENT
  DIGITAL_WALLET
}

// ========================================
// CATEGORÍAS (NIVEL 1)
// ========================================

model Category {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name  String
  color String
  icon  String?
  type  TransactionType

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subcategories Subcategory[]
  transactions  Transaction[]
  budgets       Budget[]

  @@unique([userId, name, type])
  @@index([userId])
  @@index([type])
  @@index([userId, isActive])
}

// ========================================
// SUBCATEGORÍAS (NIVEL 2)
// ========================================

model Subcategory {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  name  String
  color String?
  icon  String?

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions Transaction[]
  budgets      Budget[]

  @@unique([categoryId, name])
  @@index([userId])
  @@index([categoryId])
  @@index([categoryId, isActive])
}

// ========================================
// TRANSACCIONES
// ========================================

model Transaction {
  id          String          @id @default(cuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  accountId   String
  account     Account         @relation(fields: [accountId], references: [id], onDelete: Restrict)
  
  categoryId    String?
  category      Category?    @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  subcategoryId String?
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: SetNull)
  
  type        TransactionType
  amount      Decimal         @db.Decimal(15, 2) // Validar > 0 en app
  description String?
  date        DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([date])
  @@index([type])
}

enum TransactionType {
  INCOME
  EXPENSE
}

// ========================================
// TRANSFERENCIAS
// ========================================

model Transfer {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fromAccountId   String
  fromAccount     Account  @relation("TransfersFrom", fields: [fromAccountId], references: [id], onDelete: Restrict)
  
  toAccountId     String
  toAccount       Account  @relation("TransfersTo", fields: [toAccountId], references: [id], onDelete: Restrict)
  
  amount          Decimal  @db.Decimal(15, 2) // Validar > 0 en app
  description     String?
  date            DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@index([date])
}

// ========================================
// PRESUPUESTOS
// ========================================

model Budget {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Puede tener categoría O subcategoría (nunca ambas)
  categoryId    String?
  category      Category?    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  subcategoryId String?
  subcategory   Subcategory? @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  
  amount Decimal @db.Decimal(15, 2) // Validar > 0 en app
  month  Int     // 1-12, validar en app
  year   Int     // Validar >= año actual en app
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Un presupuesto por categoría/mes O subcategoría/mes
  @@unique([userId, categoryId, month, year])
  @@unique([userId, subcategoryId, month, year])
  @@index([userId])
  @@index([categoryId])
  @@index([subcategoryId])
  @@index([year, month])
}

// ========================================
// METAS
// ========================================

model Goal {
  id            String     @id @default(cuid())
  userId        String
  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  targetAmount  Decimal    @db.Decimal(15, 2) // Validar > 0 en app
  // NO guardar currentAmount - calcular desde Contribution
  
  startDate     DateTime   @default(now())
  endDate       DateTime?
  
  status        GoalStatus @default(ACTIVE)
  icon          String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  contributions Contribution[]
  
  @@index([userId])
  @@index([status])
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Contribution {
  id     String   @id @default(cuid())
  goalId String
  goal   Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  amount Decimal  @db.Decimal(15, 2) // Validar > 0 en app
  note   String?
  
  createdAt DateTime @default(now())
  
  @@index([goalId])
  @@index([createdAt])
}

// ========================================
// DEUDAS
// ========================================

model Debt {
  id              String     @id @default(cuid())
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name            String
  creditor        String
  totalAmount     Decimal    @db.Decimal(15, 2) // Validar > 0 en app
  remainingAmount Decimal    @db.Decimal(15, 2) // Validar >= 0 en app
  interestRate    Decimal?   @db.Decimal(5, 2)  // Porcentaje anual (ej: 15.50)
  
  startDate       DateTime   @default(now())
  dueDate         DateTime?
  paymentDay      Int?       // 1-31, validar según mes en app
  
  status          DebtStatus @default(ACTIVE)
  notes           String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  payments Payment[]
  
  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

enum DebtStatus {
  ACTIVE
  PAID
  OVERDUE
}

model Payment {
  id     String   @id @default(cuid())
  debtId String
  debt   Debt     @relation(fields: [debtId], references: [id], onDelete: Cascade)
  
  amount Decimal  @db.Decimal(15, 2) // Validar > 0 en app
  note   String?
  
  paidAt    DateTime @default(now())
  createdAt DateTime @default(now())
  
  @@index([debtId])
  @@index([paidAt])
}